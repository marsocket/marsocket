<%#
	Copyright (C) 2019 marsocket <marsocket@gmail.com>
	Licensed to the public under the GNU General Public License v3.
-%>

<% include("cbi/map") %>

<script type="text/javascript">
	(
		function() {
			XHR.poll(5, "<%=luci.dispatcher.build_url("admin", "services", "marsocket", "check_groups_status")%>", null, 
				function(x, status) {
					for (var k in status) {
						var element = document.getElementById("_status_" + k);
						element.textContent = status[k] ? "<%:Running%>" : "<%:Not Running%>";
					}			
				});
		}()
	);

	(
		function() {
			XHR.get("<%=luci.dispatcher.build_url("admin", "services", "marsocket","get_groups_nodelist")%>", null, 
				function(x, ret) {
					for (var k in ret) {
						var disabled = ret[k].disabled;
						var switch_mode = document.getElementById("cbid.<%=self.config%>." + k + ".switch_mode");
						//switch_mode.disabled = disabled;
						if (disabled) {
							switch_mode.options.remove(2);
							switch_mode.options.remove(1);
							switch_mode.options.remove(0);
						} else {
							switch_mode.options.remove(3);
						}
						var cur_node = document.getElementById("cbid.<%=self.config%>." + k + ".cur_node");
						//cur_node.disabled = disabled;
						cur_node.innerHTML="";
						var datalist = ret[k].list;
						for (var i in datalist) {
							var data = datalist[i];
							if (data.alias == "Disable") {
								data.alias = "<%:Disable%>";
							} else if (data.alias == "Not changeable") {
								data.alias = "<%:Not changeable%>";
							}
							var sel = data.selected == true ? "selected='selected'" : ""
							cur_node.innerHTML += "<option id='cbid.<%=self.config%>."+k+".cur_node-"+data.value+"' value='"+data.value+"' data-index='"+data.idx+"' data-depends='[]' "+sel+">"+data.alias+"</option>";
						}
					}
				}
			);
		}()
	);

	function on_change_switch_mode(section, mode) {
		XHR.get("<%=luci.dispatcher.build_url("admin", "services", "marsocket","switch_groups_nodelist")%>", 
			{ section: section, mode: mode }, 
			function(x, ret) {
				var element = document.getElementById("cbid.<%=self.config%>." + section + ".cur_node");
				element.disabled = ret.disabled;
				element.innerHTML="";
				var datalist = ret.list;
				for (var i in datalist) {
					var data = datalist[i];
					if (data.alias == "Disable") {
						data.alias = "<%:Disable%>";
					} else if (data.alias == "Not changeable") {
						data.alias = "<%:Not changeable%>";
					}
					var sel = data.selected == true ? "selected='selected'" : ""
					element.innerHTML += "<option id='cbid.<%=self.config%>."+section+".cur_node-"+data.value+"' value='"+data.value+"' data-index='"+data.idx+"' data-depends='[]' "+sel+">"+data.alias+"</option>";							
				}
			}
		);
	}

</script>
